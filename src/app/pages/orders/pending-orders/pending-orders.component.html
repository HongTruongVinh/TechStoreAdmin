<!-- Start Breadcrumbs -->
<app-breadcrumbs title="Orders" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>
<!-- End Breadcrumbs -->

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center g-2">
                    <div class="col-lg-3 me-auto">
                        <h6 class="card-title mb-0">Tất cả đơn hàng<span
                                class="badge bg-primary ms-1 align-baseline">{{allOrders.length}}</span></h6>
                    </div><!--end col-->
                    <div class="col-lg-4">
                        <div class="search-box">
                            <input type="text" class="form-control search" placeholder="Tìm mã đơn hàng"
                                [(ngModel)]="term" (keyup)="filterdata()">
                            <i class="ri-search-line search-icon"></i>
                        </div>
                    </div><!--end col-->
                </div>
                <div class="card-body mt-3">
                    <div class="table-responsive table-card">
                        <table class="table table-centered align-middle table-custom-effect table-nowrap mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="option"
                                                [(ngModel)]="masterSelected" (change)="checkUncheckAll($event)"
                                                id="checkAll">
                                            <label class="form-check-label" for="checkAll"></label>
                                        </div>
                                    </th>
                                    <th scope="col">Mã đơn hàng</th>
                                    <th scope="col">Trạng thái</th>
                                    <th scope="col" class="sort cursor-pointer" (click)="onSort('customerName')">Tên
                                        khách hàng</th>
                                    <th scope="col">SĐT</th>
                                    <th scope="col" class="sort cursor-pointer">Thời gian đặt hàng</th>
                                </tr>
                            </thead>
                            <tbody class="list form-check-all">
                                @for (data of displayedOrders; track $index) {
                                <tr id="l_{{data.orderId}}">
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="checkAll"
                                                value="{{data.orderId}}" [(ngModel)]="data.state"
                                                (change)="onCheckboxChange($event)">
                                            <label class="form-check-label"></label>
                                        </div>
                                    </td>
                                    <td class="order_id cursor-pointer"><a (click)="showUpdateModal(data.orderId)"
                                            class="fw-medium link-primary">#{{data.orderId}}</a></td>
                                    <td class="contact">{{data.orderStatus | orderStatus:'label'}}</td>
                                    <td class="contact">{{data.customerName}}</td>
                                    <td class="contact">{{data.customerPhonenumber}}</td>
                                    <td class="contact">{{data.createdAt | dateToString:'getDatetime'}}</td>
                                </tr>
                                }
                            </tbody><!-- end tbody -->
                        </table><!-- end table -->

                        <div *ngIf="isLoading" id="elmLoader">
                            <div class="spinner-border text-primary avatar-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <div class="noresult" [ngClass]="(displayedOrders?.length != 0)?'d-none':''">
                            <div class="text-center py-4">
                                <i class="ph-magnifying-glass fs-1 text-primary"></i>
                                <h5 class="mt-2">Sorry! No Result Found</h5>
                                <p class="text-muted mb-0">Không có kết quả tìm kiếm</p>
                            </div>
                        </div>
                    </div>
                    <div [ngClass]="(displayedOrders?.length == 0)?'d-none':''" class="row align-items-center mt-4 pt-3"
                        id="pagination-element">
                        <div class="col-sm">
                            <div class="text-muted text-center text-sm-start">
                                Hiện <span class="fw-semibold">{{displayedOrders?.length}}</span> trong tổng số <span
                                    class="fw-semibold">{{allOrders.length}}</span>
                                kết quả
                            </div>
                        </div><!--end col-->
                        <div class="col-sm-auto mt-3 mt-sm-0">
                            <pagination class="pagination-wrap hstack justify-content-center gap-2"
                                [totalItems]="displayedOrders?.length" [itemsPerPage]="10"
                                (pageChanged)="pageChanged($event)"></pagination>
                        </div><!--end col-->
                    </div><!--end row-->
                </div>
            </div>
        </div><!--end col-->
    </div><!--end row-->

</div>



<!--Update Modal-->
<div bsModal #updateModal="bs-modal" class="modal fade modal-xl" id="updateModal">
    <div class="modal-dialog">
        <div class="modal-content border-0">
            <div class="modal-header bg-primary p-3">
                <h5 class="modal-title text-white" id="orderUpdateLabel">Thông tin đơn hàng</h5>
                <button type="button" class="btn-close btn-close-white" (click)="updateModal.hide()"></button>
            </div>

            <div class="modal-body">

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-body d-flex align-items-center flex-wrap gap-3">
                                <div class="flex-grow-1">
                                    <p class="text-muted mb-2">Mã đơn hàng</p>
                                    <h6 class="fs-md mb-0">#{{selectedOrder.orderId}}</h6>
                                </div>
                                <div class="flex-shrink-0 text-end">
                                    <h6 class="fs-md mb-2">{{selectedOrder.createdAt | dateToString:'getDate'}}<i
                                            class="bi bi-calendar4-event align-baseline ms-1"></i></h6>
                                    <p class="text-muted mb-0">{{selectedOrder.createdAt | dateToString:'getTime'}}
                                        <i class="bi bi-clock align-baseline ms-1"></i>
                                    </p>
                                </div>
                            </div>
                        </div><!--end card-->
                    </div><!--end col-->
                </div><!--end row-->

                <div class="row">
                    <div class="col-xxl-3 col-md-6">
                        <div class="card border-bottom border-2 border-secondary">
                            <div class="card-body d-flex gap-3">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-3">Khách hàng</h6>
                                    <p class="fw-medium fs-md mb-1">{{selectedOrder.customerName}}</p>
                                    <p class="text-muted mb-1">{{selectedOrder.customerPhonenumber}}</p>
                                    <p class="text-muted mb-0">{{selectedOrder.shippingAddress}}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <img src="assets/images/users/48/avatar-1.jpg" alt=""
                                        class="avatar-sm rounded img-thumbnail">
                                </div>
                            </div>
                        </div>
                    </div><!--end col-->
                    <div class="col-xxl-3 col-md-6">
                        <div class="card border-bottom border-2 border-primary">
                            <div class="card-body d-flex gap-3">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-3">Giao hàng</h6>
                                    <p class="fw-medium fs-md mb-1">Đơn vị: {{selectedOrder.shipperName??'chưa có'}}</p>
                                    <p class="text-muted mb-1">Mã vận đơn: {{selectedOrder.trackingNumber??'chưa có'}}</p>
                                    <p class="text-muted mb-0">Ngày giao: {{selectedOrder.estimatedArrival??'chưa có'}}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="avatar-sm">
                                        <div class="avatar-title bg-primary-subtle text-primary fs-3 rounded">
                                            <i class="ph-truck"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!--end col-->
                    <div class="col-xxl-3 col-md-6">
                        <div class="card border-bottom border-2 border-info">
                            <div class="card-body d-flex gap-3">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-3">Hóa đơn</h6>
                                    <p class="fw-medium fs-md mb-1">ID: #{{selectedOrder.invoice?.invoiceId?? 'Chưa có hóa đơn'}}</p>
                                    <p class="text-muted mb-1">Phương thức thanh toán: {{selectedOrder.paymentMethod | paymentMethod}}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="avatar-sm">
                                        <div class="avatar-title bg-info-subtle text-info fs-3 rounded">
                                            <i class="ph-file-text"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!--end col-->
                    <div class="col-xxl-3 col-md-6">
                        <div class="card border-bottom border-2 border-light">
                            <div class="card-body d-flex gap-3">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-3">Thanh toán</h6>
                                    <p class="fw-medium fs-md mb-1">ID: #{{selectedOrder.payment?.paymentId ?? 'Chưa thanh toán'}}</p>
                                    <p class="text-muted mb-1">Phương thức: <b>{{selectedOrder.payment?.paymentMethod}}</b></p>
                                    <p class="text-muted mb-0">Trạng thái: <b>{{selectedOrder.payment?.paymentStatus}}</b></p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="avatar-sm">
                                        <div class="avatar-title bg-light text-body fs-3 rounded">
                                            <i class="ph-currency-circle-dollar"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!--end col-->

                    <div class="row">
                        <div class="col-xxl-9">
                            <div class="card">
                                <div class="card-header d-flex align-items-center gap-3">
                                    <h6 class="card-title mb-0 flex-grow-1">Danh sách sản phẩm</h6>
                                    <div class="flex-shrink-0">
                                        <button type="button" (click)="acceptOrderAction()"
                                            class="btn btn-success btn-sm me-1"><i class="align-middle"></i> Duyệt đơn
                                            hàng</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table align-middle table-nowrap table-borderless">
                                            <thead class="table-active">
                                                <tr>
                                                    <th>Tên sản phẩm</th>
                                                    <th>Giá</th>
                                                    <th>Số lượng</th>
                                                    <th class="text-end">Tổng cộng</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (orderItem of selectedOrder.items; track $index)
                                                {
                                                <tr>
                                                    <td>
                                                        <div class="product-item d-flex align-items-center gap-2">
                                                            <div class="avatar-sm flex-shrink-0">
                                                                <div class="avatar-title bg-light rounded">
                                                                    <img [src]="orderItem.mainImageUrl | fullImageUrl"
                                                                        alt="" class="avatar-xs">
                                                                </div>
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                <h6 class="fs-md"><a
                                                                        routerLink="/ecommerce/product-details"
                                                                        class="text-reset">{{orderItem.productName}}</a>
                                                                </h6>
                                                                <p class="text-muted mb-0"><a href="javascript:void(0);"
                                                                        class="text-reset">{{orderItem.categoryName}}</a>
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{orderItem.priceAtOrderTime | thousandSeparator}} VND</td>
                                                    <td>{{orderItem.quantity}}</td>
                                                    <td class="fw-medium text-end">{{orderItem.totalPrice |
                                                        thousandSeparator}} VND</td>
                                                </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div><!--end card-->
                        </div><!--end col-->
                        <div class="col-xxl-3">
                            <div class="row">
                                <div class="col-xxl-12 col-lg-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">Total order amount</h6>
                                        </div>
                                        <div class="card-body pt-4">
                                            <div class="table-responsive table-card">
                                                <table class="table table-borderless mb-0">
                                                    <tbody>
                                                    <tr>
                                                        <td>Giá tổng sản phẩm :</td>
                                                        <td class="text-end">{{selectedOrder.totalPrice|
                                                            thousandSeparator}}</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Giảm giá :</td>
                                                        <td class="text-end">-{{selectedOrder.discountAmount |
                                                            thousandSeparator}}</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Phí giao hàng :</td>
                                                        <td class="text-end">{{selectedOrder.shippingCharge |
                                                            thousandSeparator}}</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Thuế ước tính :</td>
                                                        <td class="text-end">0</td>
                                                    </tr>
                                                    <tr class="border-top border-top-dashed">
                                                        <th scope="row">Tổng (VND) :</th>
                                                        <th class="text-end">{{selectedOrder.finalAmount|
                                                            thousandSeparator}}</th>
                                                    </tr>
                                                </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--end col-->
                            </div><!--end row-->
                        </div><!--end col-->
                    </div><!--end row-->

                </div>
                
            </div>
            <!-- modal-content -->
            <div class="modal-footer">
                <div class="row hstack gap-2 justify-content-end">
                    <button *ngIf="showBtnCancel" type="button" class="btn btn-danger"
                        (click)="showInput = true; showBtnCancel = false"><i class="bi bi-x-lg align-baseline me-1"></i>Từ chối đơn
                        đặt hàng</button>
                </div>
                <div *ngIf="showInput" class="mb-3">
                    <form (ngSubmit)="cancelOrderStatusAction()" [formGroup]="cancelOrderForm" class="row tablelist-form" novalidate
                        autocomplete="off">
                        <div class="row">
                            <label for="reason-cancel-note" class="form-label">Lý do từ chối<span
                                    class="text-danger">*</span></label>
                            <input type="text" id="reason-cancel-note" formControlName="reason" class="form-control mb-3"
                                placeholder="Lý do từ chối" required>
                        </div>
                        <div class="row hstack gap-2 justify-content-end">
                            <button type="submit" class="btn btn-danger"><i class="bi bi-x-lg align-baseline me-1"></i>Xác nhận từ
                                chối</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div><!--end update modal-->
</div>